import{_ as L,c as Z,s as ee}from"./index-20ae1759.js";import{f as te,h as ue}from"./vendor-1e70d1e5.js";import{u as oe}from"./pluginConfig-bddccc63.js";import{v as ae}from"./index-5c1076ad.js";import{W as ne,a as R}from"./webrtc-b8715042.js";const le={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 20 20"},re={id:"volume",x1:"0%",y1:"60%",x2:"0%",y2:"0%"},se=Vue.createElementVNode("stop",{offset:"0%","stop-color":"cyan","stop-opacity":"1"},null,-1),ce=["offset"],ie=["offset"],de=Vue.createElementVNode("stop",{offset:"100%","stop-color":"cyan","stop-opacity":"0"},null,-1),ve=Vue.createElementVNode("path",{d:"M5.5 10a.5.5 0 0 0-1 0a5.5 5.5 0 0 0 5 5.478V17.5a.5.5 0 0 0 1 0v-2.022a5.5 5.5 0 0 0 5-5.478a.5.5 0 0 0-1 0a4.5 4.5 0 1 1-9 0zm7.5 0a3 3 0 0 1-6 0V5a3 3 0 0 1 6 0v5z",fill:"url(#volume)"},null,-1),me=Vue.createElementVNode("path",{d:"M10 13a3 3 0 0 0 3-3V5a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm0-1a2 2 0 0 1-2-2V5a2 2 0 1 1 4 0v5a2 2 0 0 1-2 2zM5 9.5a.5.5 0 0 1 .5.5a4.5 4.5 0 1 0 9 0a.5.5 0 0 1 1 0a5.5 5.5 0 0 1-5 5.478V17.5a.5.5 0 0 1-1 0v-2.022A5.5 5.5 0 0 1 4.5 10a.5.5 0 0 1 .5-.5z",fill:"currentColor"},null,-1),Ve={key:1,d:"M12 5v4.879l.898.898c.067-.248.102-.508.102-.777V5a3 3 0 0 0-5.998-.119L8 5.879V5a2 2 0 1 1 4 0zM7 7.707L2.146 2.854a.5.5 0 1 1 .708-.708l15 15a.5.5 0 0 1-.708.708l-3.627-3.627a5.475 5.475 0 0 1-3.019 1.25V17.5a.5.5 0 0 1-1 0v-2.022A5.5 5.5 0 0 1 4.5 10a.5.5 0 0 1 1 0a4.5 4.5 0 0 0 7.309 3.516l-1.07-1.07A3 3 0 0 1 7 10V7.706zm4.016 4.016L8 8.707V10a2 2 0 0 0 3.016 1.723zm3.787.959l-.742-.742A4.481 4.481 0 0 0 14.5 10a.5.5 0 0 1 1 0c0 .974-.253 1.888-.697 2.682z",fill:"currentColor"},fe={key:2,d:"M9 13c.07 0 .14-.002.21-.007c.11-.387.26-.757.448-1.104A2 2 0 0 1 7 10V5.001a2 2 0 1 1 4 0v5c0 .092-.006.183-.018.272c.312-.26.653-.486 1.018-.672V5a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm-4.5-3A4.5 4.5 0 0 0 9 14.5c0 .819.179 1.596.5 2.294v.706a.5.5 0 0 1-1 0v-2.022A5.5 5.5 0 0 1 3.5 10a.5.5 0 0 1 1 0zm10 9a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9zm0-8a3.5 3.5 0 0 0-2.803 5.596l4.9-4.9A3.484 3.484 0 0 0 14.5 11zm-2.096 6.303a3.5 3.5 0 0 0 4.9-4.9l-4.9 4.9z",fill:"currentColor"},K=Vue.defineComponent({__name:"mic",props:{hasMic:{type:Boolean},muted:{type:Boolean},volume:null},setup(c){return(i,t)=>(Vue.openBlock(),Vue.createElementBlock("svg",le,[Vue.createElementVNode("defs",null,[Vue.createElementVNode("linearGradient",re,[se,Vue.createElementVNode("stop",{offset:c.volume+"%","stop-color":"cyan","stop-opacity":"1"},null,8,ce),Vue.createElementVNode("stop",{offset:c.volume+.1+"%","stop-color":"cyan","stop-opacity":"0"},null,8,ie),de])]),Vue.createElementVNode("g",null,[c.hasMic&&!c.muted?(Vue.openBlock(),Vue.createElementBlock(Vue.Fragment,{key:0},[ve,me],64)):c.hasMic?(Vue.openBlock(),Vue.createElementBlock("path",Ve)):(Vue.openBlock(),Vue.createElementBlock("path",fe))])]))}});const pe={class:"user"},_e=["srcObject"],he={class:"title"},ke=Vue.defineComponent({__name:"user",props:{value:null,title:null,audioContext:null},setup(c){const i=c,t=Vue.ref(),o=new MediaStream,v=Vue.ref(0);return Vue.watchEffect(()=>{if(i.value){if(i.value.audioTrack&&o.getAudioTracks().length==0){let k=function(){if(i.audioContext.state=="closed")return;e.getByteFrequencyData(_);let r=0;for(let F=0;F<_.length;F++)r+=_[F];v.value=r/_.length,requestAnimationFrame(k)};o.addTrack(i.value.audioTrack);const a=i.audioContext.createMediaStreamSource(o),e=i.audioContext.createAnalyser();a.connect(e);const _=new Uint8Array(e.frequencyBinCount);k()}i.value.videoTrack&&o.getVideoTracks().length==0&&o.addTrack(i.value.videoTrack),(i.value.audioTrack||i.value.videoTrack)&&t.value&&t.value.play()}}),(k,a)=>(Vue.openBlock(),Vue.createElementBlock("div",pe,[Vue.createElementVNode("video",{ref_key:"videoEle",ref:t,srcObject:Vue.unref(o),autoplay:""},null,8,_e),Vue.createElementVNode("div",he,[Vue.createTextVNode(Vue.toDisplayString(c.title)+" ",1),Vue.createVNode(K,{class:"mic",muted:c.value&&c.value.audioTrack&&!c.value.audioTrack.enabled,"has-mic":c.value&&c.value.audioTrack,volume:v.value},null,8,["muted","has-mic","volume"])])]))}}),ye=L(ke,[["__scopeId","data-v-68246116"]]);const Ce={class:"user"},ge={class:"title"},Fe={key:0,class:"camlist"},we=Vue.defineComponent({__name:"myself",props:{value:null,title:null,signalReady:{type:Boolean},audioContext:null},emits:["update:value","publish","unpublish"],setup(c,{emit:i}){const t=c,o=Vue.ref(),v=Vue.ref([]),k=Z(),a=Vue.ref(k.getCurrentCamera),e=Vue.ref(),_=Vue.ref(0),r=new MediaStream;navigator.mediaDevices.enumerateDevices().then(s=>{v.value=s.filter(V=>V.kind=="videoinput"),!v.value.find(V=>V.deviceId==a.value)&&(a.value=v.value[0].deviceId)});function F(){e.value&&(e.value.enabled=!e.value.enabled)}return Vue.onUnmounted(()=>{t.value.mediaStream&&t.value.mediaStream.getTracks().forEach(s=>s.stop())}),Vue.watchEffect(()=>{k.setCurrentCamera(a.value),navigator.mediaDevices.getUserMedia({audio:!0,video:a.value?{deviceId:a.value}:!0}).then(s=>{t.value.mediaStream&&t.value.mediaStream.getTracks().forEach(w=>w.stop()),t.value.mediaStream=s,e.value=s.getAudioTracks()[0];const V=s.getVideoTracks()[0];if(e.value){if(r.getAudioTracks().length==0){let w=function(){if(t.audioContext.state=="closed")return;D.getByteFrequencyData(h);let N=0;for(let E=0;E<h.length;E++)N+=h[E];_.value=N/h.length,requestAnimationFrame(w)};r.addTrack(e.value);const f=t.audioContext.createMediaStreamSource(r),D=t.audioContext.createAnalyser();f.connect(D);const h=new Uint8Array(D.frequencyBinCount);w()}else r.removeTrack(r.getAudioTracks()[0]),r.addTrack(e.value);t.value.audioTransceiver&&t.value.audioTransceiver.sender.replaceTrack(e.value)}t.value.videoTransceiver&&V&&t.value.videoTransceiver.sender.replaceTrack(V),i("update:value",t.value)})}),Vue.watchEffect(()=>{t.value.mediaStream&&o.value&&(o.value.srcObject=t.value.mediaStream,o.value.muted=!0,o.value.play().catch(()=>{}))}),(s,V)=>{const w=Vue.resolveComponent("n-select");return Vue.openBlock(),Vue.createElementBlock("div",Ce,[Vue.createElementVNode("video",{ref_key:"videoEle",ref:o,autoplay:""},null,512),Vue.createElementVNode("div",ge,[Vue.createTextVNode(Vue.toDisplayString(c.title)+" ",1),Vue.createVNode(K,{class:"mic",onClick:F,muted:e.value!=null&&!e.value.enabled,"has-mic":e.value!=null,volume:_.value},null,8,["muted","has-mic","volume"])]),v.value.length>1?(Vue.openBlock(),Vue.createElementBlock("div",Fe,[Vue.createVNode(w,{value:a.value,"onUpdate:value":V[0]||(V[0]=f=>a.value=f),options:v.value,"value-field":"deviceId"},null,8,["value","options"])])):Vue.createCommentVNode("",!0)])}}}),xe=L(we,[["__scopeId","data-v-3953e43e"]]);const De=Vue.createTextVNode(" 正在等待WebRTC连接 "),Ee=Vue.createTextVNode(" WebRTC已连接 "),Be=Vue.createTextVNode(" 正在发布流 "),Ne=Vue.createTextVNode(" 当前实例未安装插件，无法创建房间 "),Se=Vue.createTextVNode("发送"),Te=Vue.createTextVNode("返回"),be=Vue.createTextVNode(" 进入 "),Ae=Vue.defineComponent({__name:"index",setup(c){const i=Vue.ref(!0),t=te(),o=Vue.reactive([]),v=Vue.ref(""),k=ue(),a=naive.useMessage(),e=Vue.ref("usr"+Math.random().toString(36).substr(2,9)),_=Vue.ref("");let r;const F=oe(),s=k.params.id,V=Vue.ref(!1),w=Vue.ref("room"),f=Vue.ref(k.query.pass||"test"),D=Vue.ref(""),h=Vue.ref(!1),N=Vue.ref(),E=Vue.ref(!1),U=Vue.computed(()=>location.protocol+"//"+location.host+"/#/instance/room?pass="+D.value),z=location.protocol.replace("http","ws")+`//${location.host}/m7sws`;let B;const S=Vue.ref(),y=new ne("m7s/webrtc/batch",{requestInit:{headers:{m7sid:s}}}),C=y.webrtc,I=new AudioContext;Vue.onUnmounted(()=>{I.close(),y.close(),r==null||r.close()}),ee({url:"/api/user/islogin",method:"POST"}).then(n=>{n.code===0&&(e.value=n.data)}),s&&(F.getConfig(s,"Room").then(n=>w.value=n.appname).catch(()=>V.value=!0),F.getConfig(s,"").then(n=>{}));function G(){navigator.clipboard.writeText(U.value).then(()=>{a.success("链接已复制到剪切板")})}function H(n){n.key==="Enter"&&J()}function Q(){s?(ae(s,f.value).then(n=>{D.value=n}),q([z,"room",f.value,e.value].join("/")+"?m7sid="+s)):(q(`${z}/room/join?${new URLSearchParams({userId:e.value,pass:f.value})}`),y.options.requestInit.headers.pass=f.value)}async function O(){if(S.value&&S.value.mediaStream&&h.value&&!E.value){E.value=!0;const n=S.value;y.addStream(n);const u=await C.createOffer();await C.setLocalDescription(u),B.send(JSON.stringify({type:"publish",offer:u.sdp,streamPath:`room/${f.value}/${e.value}?token=${_.value}`}))}}function q(n){S.value=new R(e.value,"sendonly"),r=new WebSocket(n),r.onmessage=u=>{const{data:l,event:b,userId:g}=JSON.parse(u.data);switch(console.log(l,b,g),b){case"joined":if(_.value=l.token,f.value=_.value.split(":")[0],a.success("成功加入房间"),i.value=!1,B=C.createDataChannel("signal"),B.onmessage=async d=>{const m=JSON.parse(d.data);switch(console.log(m),m.type){case"answer":C.setRemoteDescription(new RTCSessionDescription(m));break;case"remove":y.deleteStream(m.streamPath);const A=o.find(P=>P.StreamPath==m.streamPath);A&&(A.StreamPath="");break;case"offer":await C.setRemoteDescription(new RTCSessionDescription(m));const $=await C.createAnswer();await C.setLocalDescription($),B.send(JSON.stringify($))}},B.onopen=async()=>{a.success("成功连接信令服务器"),h.value=!0,O(),j()},B.onclose=()=>{a.error("信令服务器连接断开"),h.value=!1},l.userList)for(const d of l.userList){if(M(d.ID))continue;o.push(d);const m=d.StreamPath;m&&(d.Stream=Vue.reactive(new R(m)),y.addStream(d.Stream))}y.connect().catch(d=>{N.value=d,a.error("连接失败"+d)});break;case"msg":a.info(`${g}：${l}`);break;case"userjoin":a.success(l.ID+"加入房间"),M(l.ID)||o.push(l);break;case"userleave":a.info(g+"离开房间");{const d=W(g);d&&(d.StreamPath&&y.deleteStream(d.StreamPath),o.splice(o.findIndex(m=>m.ID===g),1))}break;case"publish":const T=l,x=W(g);x&&!M(g)&&(x.StreamPath=T,x.Stream=new R(T),y.addStream(x.Stream),j());break}},r.onerror=u=>{a.error("进入房间失败")}}async function j(){if(!h.value)return;const n=[];for(const l of o)l.StreamPath&&n.push(l.StreamPath);const u=await C.createOffer();console.log(u),await C.setLocalDescription(u),B.send(JSON.stringify({type:"subscribe",offer:u.sdp,streamList:n}))}function W(n){return o.find(u=>u.ID===n)}function M(n){return e.value===n}function J(){r?(r.send(v.value),v.value=""):a.error("未连接到服务器")}return(n,u)=>{const l=Vue.resolveComponent("n-alert"),b=Vue.resolveComponent("n-space"),g=Vue.resolveComponent("n-layout-content"),T=Vue.resolveComponent("n-input"),x=Vue.resolveComponent("n-button"),d=Vue.resolveComponent("n-input-group"),m=Vue.resolveComponent("n-layout-footer"),A=Vue.resolveComponent("n-form-item-row"),$=Vue.resolveComponent("n-form"),P=Vue.resolveComponent("n-card"),X=Vue.resolveComponent("n-modal"),Y=Vue.resolveComponent("n-layout");return Vue.openBlock(),Vue.createBlock(Y,null,{default:Vue.withCtx(()=>[Vue.createVNode(g,{"content-style":"padding: 24px;height:calc(100vh - 120px)"},{default:Vue.withCtx(()=>[Vue.createVNode(b,null,{default:Vue.withCtx(()=>[N.value?(Vue.openBlock(),Vue.createBlock(l,{key:0,type:"error"},{default:Vue.withCtx(()=>[Vue.createTextVNode(" WebRTC连接失败："+Vue.toDisplayString(N.value),1)]),_:1})):h.value?(Vue.openBlock(),Vue.createBlock(l,{key:2,type:"success"},{default:Vue.withCtx(()=>[Ee]),_:1})):(Vue.openBlock(),Vue.createBlock(l,{key:1,type:"warning"},{default:Vue.withCtx(()=>[De]),_:1})),E.value?(Vue.openBlock(),Vue.createBlock(l,{key:3,type:"success"},{default:Vue.withCtx(()=>[Be]),_:1})):Vue.createCommentVNode("",!0),V.value?(Vue.openBlock(),Vue.createBlock(l,{key:4,title:"当前功能受限",type:"error"},{default:Vue.withCtx(()=>[Ne]),_:1})):D.value?(Vue.openBlock(),Vue.createBlock(l,{key:5,type:"success",onClick:G},{default:Vue.withCtx(()=>[Vue.createTextVNode("邀请他人入房链接（点击复制到剪切板）："+Vue.toDisplayString(Vue.unref(U)),1)]),_:1})):Vue.createCommentVNode("",!0)]),_:1}),Vue.createVNode(b,null,{default:Vue.withCtx(()=>[S.value?(Vue.openBlock(),Vue.createBlock(xe,{key:0,title:e.value,value:S.value,signalReady:h.value,"onUpdate:value":O,"audio-context":Vue.unref(I)},null,8,["title","value","signalReady","audio-context"])):Vue.createCommentVNode("",!0),(Vue.openBlock(!0),Vue.createElementBlock(Vue.Fragment,null,Vue.renderList(o,p=>(Vue.openBlock(),Vue.createBlock(ye,{title:p.ID,key:p.ID,value:p.Stream,"audio-context":Vue.unref(I)},null,8,["title","value","audio-context"]))),128))]),_:1})]),_:1}),Vue.createVNode(m,null,{default:Vue.withCtx(()=>[Vue.createVNode(d,null,{default:Vue.withCtx(()=>[Vue.createVNode(T,{value:v.value,"onUpdate:value":u[0]||(u[0]=p=>v.value=p),clearable:"",placeholder:"发送聊天信息",onKeyup:H},null,8,["value"]),Vue.createVNode(x,{type:"primary",onClick:J},{default:Vue.withCtx(()=>[Se]),_:1})]),_:1})]),_:1}),Vue.createVNode(X,{show:i.value,"onUpdate:show":u[4]||(u[4]=p=>i.value=p),"close-on-esc":!1,"mask-closable":!1},{default:Vue.withCtx(()=>[Vue.createVNode(P,{style:{width:"600px"},title:Vue.unref(s)?"进入房间":"加入房间",bordered:!1,size:"huge",role:"dialog","aria-modal":"true"},{"header-extra":Vue.withCtx(()=>[Vue.createVNode(x,{type:"primary",onClick:u[1]||(u[1]=p=>Vue.unref(t).back())},{default:Vue.withCtx(()=>[Te]),_:1})]),footer:Vue.withCtx(()=>[Vue.createVNode(x,{type:"primary",block:"",secondary:"",strong:"",onClick:Q},{default:Vue.withCtx(()=>[be]),_:1})]),default:Vue.withCtx(()=>[Vue.createVNode($,null,{default:Vue.withCtx(()=>[Vue.createVNode(A,{label:Vue.unref(s)?"房间名称":"入房口令"},{default:Vue.withCtx(()=>[Vue.createVNode(T,{value:f.value,"onUpdate:value":u[2]||(u[2]=p=>f.value=p)},null,8,["value"])]),_:1},8,["label"]),Vue.createVNode(A,{label:"用户名称"},{default:Vue.withCtx(()=>[Vue.createVNode(T,{value:e.value,"onUpdate:value":u[3]||(u[3]=p=>e.value=p)},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["title"])]),_:1},8,["show"])]),_:1})}}}),Le=L(Ae,[["__scopeId","data-v-316bf44f"]]);export{Le as default};
