var G=Object.defineProperty;var q=(n,t,e)=>t in n?G(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var f=(n,t,e)=>(q(n,typeof t!="symbol"?t+"":t,e),e);var U={},H={get exports(){return U},set exports(n){U=n}};(function(n){var t=Object.prototype.hasOwnProperty,e="~";function s(){}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(e=!1));function h(a,r,o){this.fn=a,this.context=r,this.once=o||!1}function d(a,r,o,c,u){if(typeof o!="function")throw new TypeError("The listener must be a function");var w=new h(o,c||a,u),v=e?e+r:r;return a._events[v]?a._events[v].fn?a._events[v]=[a._events[v],w]:a._events[v].push(w):(a._events[v]=w,a._eventsCount++),a}function l(a,r){--a._eventsCount===0?a._events=new s:delete a._events[r]}function p(){this._events=new s,this._eventsCount=0}p.prototype.eventNames=function(){var r=[],o,c;if(this._eventsCount===0)return r;for(c in o=this._events)t.call(o,c)&&r.push(e?c.slice(1):c);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(o)):r},p.prototype.listeners=function(r){var o=e?e+r:r,c=this._events[o];if(!c)return[];if(c.fn)return[c.fn];for(var u=0,w=c.length,v=new Array(w);u<w;u++)v[u]=c[u].fn;return v},p.prototype.listenerCount=function(r){var o=e?e+r:r,c=this._events[o];return c?c.fn?1:c.length:0},p.prototype.emit=function(r,o,c,u,w,v){var b=e?e+r:r;if(!this._events[b])return!1;var i=this._events[b],y=arguments.length,T,g;if(i.fn){switch(i.once&&this.removeListener(r,i.fn,void 0,!0),y){case 1:return i.fn.call(i.context),!0;case 2:return i.fn.call(i.context,o),!0;case 3:return i.fn.call(i.context,o,c),!0;case 4:return i.fn.call(i.context,o,c,u),!0;case 5:return i.fn.call(i.context,o,c,u,w),!0;case 6:return i.fn.call(i.context,o,c,u,w,v),!0}for(g=1,T=new Array(y-1);g<y;g++)T[g-1]=arguments[g];i.fn.apply(i.context,T)}else{var F=i.length,O;for(g=0;g<F;g++)switch(i[g].once&&this.removeListener(r,i[g].fn,void 0,!0),y){case 1:i[g].fn.call(i[g].context);break;case 2:i[g].fn.call(i[g].context,o);break;case 3:i[g].fn.call(i[g].context,o,c);break;case 4:i[g].fn.call(i[g].context,o,c,u);break;default:if(!T)for(O=1,T=new Array(y-1);O<y;O++)T[O-1]=arguments[O];i[g].fn.apply(i[g].context,T)}}return!0},p.prototype.on=function(r,o,c){return d(this,r,o,c,!1)},p.prototype.once=function(r,o,c){return d(this,r,o,c,!0)},p.prototype.removeListener=function(r,o,c,u){var w=e?e+r:r;if(!this._events[w])return this;if(!o)return l(this,w),this;var v=this._events[w];if(v.fn)v.fn===o&&(!u||v.once)&&(!c||v.context===c)&&l(this,w);else{for(var b=0,i=[],y=v.length;b<y;b++)(v[b].fn!==o||u&&!v[b].once||c&&v[b].context!==c)&&i.push(v[b]);i.length?this._events[w]=i.length===1?i[0]:i:l(this,w)}return this},p.prototype.removeAllListeners=function(r){var o;return r?(o=e?e+r:r,this._events[o]&&l(this,o)):(this._events=new s,this._eventsCount=0),this},p.prototype.off=p.prototype.removeListener,p.prototype.addListener=p.prototype.on,p.prefixed=e,p.EventEmitter=p,n.exports=p})(H);const j=Symbol("instance"),D=Symbol("abortCtrl"),E=Symbol("cacheResult");class V{constructor(t,e,s){f(this,"oldState");f(this,"newState");f(this,"action");f(this,"error");this.oldState=t,this.newState=e,this.action=s}toString(){return`${this.action}ing`}}class k extends Error{constructor(e,s,h){super(s);f(this,"state");f(this,"message");f(this,"cause");this.state=e,this.message=s,this.cause=h}}const S=new Map,B=Object.getPrototypeOf((async()=>{})()).constructor;function A(n,t,e={}){return(s,h,d)=>{const l=h;S.has(s)||(S.set(s,[]),Object.defineProperty(s,"stateDiagram",{configurable:!0,get(){let a=new Set,r=[],o=[];const c=S.get(s),u=new Set;Object.defineProperty(s,"allStates",{value:u});const w=Object.getPrototypeOf(s);S.has(w)&&(w.stateDiagram.forEach(b=>a.add(b)),w.allStates.forEach(b=>u.add(b))),c.forEach(({from:b,to:i,action:y})=>{typeof b=="string"?r.push({from:b,to:i,action:y}):b.length?b.forEach(T=>{r.push({from:T,to:i,action:y})}):o.push({to:i,action:y})}),r.forEach(({from:b,to:i,action:y})=>{u.add(b),u.add(i),u.add(y+"ing"),a.add(`${b} --> ${y}ing : ${y}`),a.add(`${y}ing --> ${i} : ${y} ðŸŸ¢`),a.add(`${y}ing --> ${b} : ${y} ðŸ”´`)}),o.forEach(({to:b,action:i})=>{a.add(`${i}ing --> ${b} : ${i} ðŸŸ¢`),u.forEach(y=>{y!==b&&a.add(`${y} --> ${i}ing : ${i}`)})});const v=[...a];return Object.defineProperty(s,"stateDiagram",{value:v}),v}})),S.get(s).push({from:n,to:t,action:l});const p=d.value;d.value=async function(...a){if(this.state===t)return this[E];let r=null;if(Array.isArray(n)?n.length==0?this[D]&&(this[D].aborted=!0):(typeof this.state!="string"||!n.includes(this.state))&&(r=new k(this._state,`${this.name} ${l} to ${t} failed: current state ${this._state} not in from config`)):n!==this.state&&(r=new k(this._state,`${this.name} ${l} to ${t} failed: current state ${this._state} not from ${n}`)),r){if(e.ignoreError)return r;throw r}const o=this.state;P.call(this,new V(o,t,l));const c={aborted:!1};this[D]=c;try{const u=p.apply(this,a);return u instanceof B?this[E]=await u:this[E]=u,c.aborted?this[E]:(this[D]=void 0,P.call(this,t),this[E])}catch(u){const w=u instanceof Error?u.message:String(u);if(P.call(this,o,w),e.ignoreError)return u;throw u}}}}function J(...n){return(t,e,s)=>{const h=s.value,d=e;s.value=function(...l){if(!n.includes(this.state.toString()))throw new k(this.state,`${this.name} ${d} failed: current state ${this.state} not in ${n}`);return h.apply(this,l)}}}const K=(()=>typeof window<"u"&&window.__AFSM__?(e,s)=>{window.dispatchEvent(new CustomEvent(e,{detail:s}))}:typeof importScripts<"u"?(e,s)=>{postMessage({type:e,payload:s})}:()=>{})();function P(n,t){const e=this._state;this._state=n;const s=n.toString();n&&this.emit(s,e),this.emit(m.STATECHANGED,n,e,t),this.updateDevTools({value:n,old:e,err:t})}var z,ee;const $=class extends U{constructor(e,s){super();f(this,"name");f(this,"groupName");f(this,"_state",$.INIT);f(this,z);f(this,ee);this.name=e,this.groupName=s,e||(e=Date.now().toString(36));const h=Object.getPrototypeOf(this);s||(this.groupName=this.constructor.name);const d=h[j];d?this.name=d.name+"-"+d.count++:h[j]={name:this.name,count:0},this.updateDevTools({diagram:this.stateDiagram})}get stateDiagram(){return[]}updateDevTools(e={}){K($.UPDATEAFSM,{name:this.name,group:this.groupName,...e})}get state(){return this._state}};let m=$;z=E,ee=D,f(m,"STATECHANGED","stateChanged"),f(m,"UPDATEAFSM","updateAFSM"),f(m,"INIT","[*]"),f(m,"ON","on"),f(m,"OFF","off");var _=(n=>(n.CONNECTED="connected",n.DISCONNECTED="disconnected",n.RECONNECTED="reconnected",n))(_||{}),Q=globalThis&&globalThis.__awaiter||function(n,t,e,s){function h(d){return d instanceof e?d:new e(function(l){l(d)})}return new(e||(e=Promise))(function(d,l){function p(o){try{r(s.next(o))}catch(c){l(c)}}function a(o){try{r(s.throw(o))}catch(c){l(c)}}function r(o){o.done?d(o.value):h(o.value).then(p,a)}r((s=s.apply(n,t||[])).next())})};const L=Symbol(32),I=Symbol(16),R=Symbol(8);class N{constructor(t){this.g=t,this.consumed=0,t&&(this.need=t.next().value)}setG(t){this.g=t,this.demand(t.next().value,!0)}consume(){this.buffer&&this.consumed&&(this.buffer.copyWithin(0,this.consumed),this.buffer=this.buffer.subarray(0,this.buffer.length-this.consumed),this.consumed=0)}demand(t,e){return e&&this.consume(),this.need=t,this.flush()}read(t){return Q(this,void 0,void 0,function*(){return this.lastReadPromise&&(yield this.lastReadPromise),this.lastReadPromise=new Promise((e,s)=>{var h;this.reject=s,this.resolve=l=>{delete this.lastReadPromise,delete this.resolve,delete this.need,e(l)},this.demand(t,!0)||(h=this.pull)===null||h===void 0||h.call(this,t)})})}readU32(){return this.read(L)}readU16(){return this.read(I)}readU8(){return this.read(R)}close(){var t;this.g&&this.g.return(),this.buffer&&this.buffer.subarray(0,0),(t=this.reject)===null||t===void 0||t.call(this,new Error("EOF")),delete this.lastReadPromise}flush(){if(!this.buffer||!this.need)return;let t=null;const e=this.buffer.subarray(this.consumed);let s=0;const h=d=>e.length<(s=d);if(typeof this.need=="number"){if(h(this.need))return;t=e.subarray(0,s)}else if(this.need===L){if(h(4))return;t=e[0]<<24|e[1]<<16|e[2]<<8|e[3]}else if(this.need===I){if(h(2))return;t=e[0]<<8|e[1]}else if(this.need===R){if(h(1))return;t=e[0]}else if("buffer"in this.need){if("byteOffset"in this.need){if(h(this.need.byteLength-this.need.byteOffset))return;new Uint8Array(this.need.buffer,this.need.byteOffset).set(e.subarray(0,s)),t=this.need}else if(this.g){this.g.throw(new Error("Unsupported type"));return}}else{if(h(this.need.byteLength))return;new Uint8Array(this.need).set(e.subarray(0,s)),t=this.need}return this.consumed+=s,this.g?this.demand(this.g.next(t).value,!0):this.resolve&&this.resolve(t),t}write(t){if(t instanceof Uint8Array?this.malloc(t.length).set(t):"buffer"in t?this.malloc(t.byteLength).set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)):this.malloc(t.byteLength).set(new Uint8Array(t)),this.g||this.resolve)this.flush();else return new Promise(e=>this.pull=e)}writeU32(t){this.malloc(4).set([t>>24&255,t>>16&255,t>>8&255,t&255]),this.flush()}writeU16(t){this.malloc(2).set([t>>8&255,t&255]),this.flush()}writeU8(t){this.malloc(1)[0]=t,this.flush()}malloc(t){if(this.buffer){const e=this.buffer.length,s=e+t;if(s<=this.buffer.buffer.byteLength-this.buffer.byteOffset)this.buffer=new Uint8Array(this.buffer.buffer,this.buffer.byteOffset,s);else{const h=new Uint8Array(s);h.set(this.buffer),this.buffer=h}return this.buffer.subarray(e,s)}else return this.buffer=new Uint8Array(t),this.buffer}}N.U32=L;N.U16=I;N.U8=R;var X=Object.defineProperty,Y=Object.getOwnPropertyDescriptor,x=(n,t,e,s)=>{for(var h=s>1?void 0:s?Y(t,e):t,d=n.length-1,l;d>=0;d--)(l=n[d])&&(h=(s?l(t,e,h):l(h))||h);return s&&h&&X(t,e,h),h};function M(n,t=1,e=1){return n<=1?e:M(n-1,e,t+e)}function Z(n){const t=Math.round(n/2)+1;return t>6?13*1e3:M(t)*1e3}class W{constructor(){f(this,"total",0);f(this,"_buffer",0);f(this,"lastTime",0);f(this,"_bps",0)}add(t){const e=Date.now();this._buffer+=t,this.lastTime===0?this.lastTime=e:e-this.lastTime>1e3&&(this._bps=this._buffer*1e3/(e-this.lastTime)>>0,this._buffer=0,this.lastTime=e),this.total+=t}get bps(){return Date.now()-this.lastTime>5e3?0:this._bps}}class C extends m{constructor(e,s={}){super(e||"conn","Connection");f(this,"oput");f(this,"up",new W);f(this,"down",new W);f(this,"underlyingSink",{write:async e=>{var s;return this.down.add(e.length||e.byteLength),(s=this.oput)==null?void 0:s.write(e)}});f(this,"abortCtrl");this.url=e,this.options=s,this.options.reconnectTimeout||(this.options.reconnectTimeout=Z)}read(e){return Promise.reject("not connected")}async connect(){this.abortCtrl=new AbortController,console.log(`connected: ${this.url}`),console.time(this.url),this.onConnected(await this._connect())}_close(){}_send(e){}async reconnect(){console.log(`reconnect: ${this.url}`),console.time(this.url),this.abortCtrl=new AbortController,this.onConnected(await this._connect())}onConnected(e){if(console.timeEnd(this.url),!!e)return this.oput||(this.oput=new N),this.read=this.oput.read.bind(this.oput),e.pipeTo(new WritableStream(this.underlyingSink),this.abortCtrl).catch(s=>{this.abortCtrl.signal.aborted||this.disconnect(s)})}disconnect(e){console.warn(`disconnect: ${this.url}`,e),this.options.reconnectCount&&this.reconnectAfter()}reconnectAfter(e=1e3,s=0){console.log(`reconnect after ${e}ms`),setTimeout(()=>{this.reconnect().catch(h=>{console.log(`reconnect failed: ${this.url}`,h),s<this.options.reconnectCount&&this.reconnectAfter(this.options.reconnectTimeout(s),s+1)})},e)}close(){var e;(e=this.abortCtrl)==null||e.abort(),this._close()}send(e){this.up.add(e.byteLength-("byteOffset"in e?e.byteOffset:0)),this._send(e)}}x([J(_.CONNECTED)],C.prototype,"read",1);x([A([_.DISCONNECTED,m.INIT],_.CONNECTED)],C.prototype,"connect",1);x([A(_.DISCONNECTED,_.RECONNECTED)],C.prototype,"reconnect",1);x([A(_.CONNECTED,_.DISCONNECTED)],C.prototype,"disconnect",1);x([A([],m.INIT)],C.prototype,"close",1);class se extends C{constructor(t){super(t.label),this.dc=t}async _connect(){return new ReadableStream({start:t=>{this.dc.onclose=()=>{t.close()},this.dc.onerror=e=>{t.error(e)},this.dc.onmessage=e=>{t.enqueue(e.data)}}})}_close(){this.dc.close()}_send(t){this.dc.send(t)}}class ne{constructor(t,e="recvonly"){f(this,"mediaStream");f(this,"audioTransceiver");f(this,"videoTransceiver");f(this,"_videoTrack");f(this,"_audioTrack");this.id=t,this.direction=e}set audioTrack(t){this._audioTrack=t}get audioTrack(){var t;return this._audioTrack||((t=this.mediaStream)==null?void 0:t.getAudioTracks()[0])}set videoTrack(t){this._videoTrack=t}get videoTrack(){var t;return this._videoTrack||((t=this.mediaStream)==null?void 0:t.getVideoTracks()[0])}close(){}}class ie extends C{constructor(){super(...arguments);f(this,"webrtc",new RTCPeerConnection(this.options.rtcConfig));f(this,"streams",new Map);f(this,"videoTransceiver",new Array);f(this,"audioTransceiver",new Array)}async _connect(){const e=await this.webrtc.createOffer();await this.webrtc.setLocalDescription(e);const h=await(await fetch(this.url,{method:"POST",body:e.sdp,...this.options.requestInit||{}})).text();return await this.webrtc.setRemoteDescription({type:"answer",sdp:h}),this.webrtc.ontrack=({track:d,streams:l,transceiver:p})=>{if(console.log(d,l,p),l.length){const a=this.streams.get(l[0].id);a&&a.direction==="recvonly"&&(a.mediaStream=l[0])}},new Promise((d,l)=>{this.webrtc.onconnectionstatechange=p=>{switch(this.webrtc.connectionState){case"disconnected":this.disconnect(p);break;case"connected":d();break;case"failed":l(p)}}})}addStream(e){return this.audioTransceiver.length?(e.audioTransceiver=this.audioTransceiver.pop(),e.audioTransceiver.direction=e.direction):e.audioTransceiver=this.webrtc.addTransceiver(e.audioTrack||"audio",{direction:e.direction}),this.videoTransceiver.length?(e.videoTransceiver=this.videoTransceiver.pop(),e.videoTransceiver.direction=e.direction):e.videoTransceiver=this.webrtc.addTransceiver(e.videoTrack||"video",{direction:e.direction}),this.streams.set(e.id,e),e}deleteStream(e){const s=this.streams.get(e);s&&(delete s.mediaStream,s.audioTransceiver.direction="inactive",s.videoTransceiver.direction="inactive",this.audioTransceiver.push(s.audioTransceiver),this.videoTransceiver.push(s.videoTransceiver),this.streams.delete(e))}_close(){var e;(e=this.webrtc)==null||e.close()}}export{A as C,se as D,m as F,J as I,N as O,ie as W,ne as a,U as e};
