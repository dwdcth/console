System.register(["./index-legacy.ee50fea4.js","./vendor-legacy.9d0d38ef.js","./pluginConfig-legacy.bb2e7770.js","./index-legacy.d1f2a5dd.js","./webrtc-legacy.561dcd55.js"],(function(e,t){"use strict";var a,o,u,l,n,r,c,i,s,d=document.createElement("style");return d.textContent=".user[data-v-02a9d378]{width:320px;height:240px;border:1px solid gray;position:relative;color:#fff;background-color:#000}.mic[data-v-02a9d378]{cursor:pointer;position:absolute;bottom:0;left:0;width:30px;height:30px}.title[data-v-02a9d378]{position:absolute;bottom:0;left:0;width:100%;height:30px;line-height:30px;text-align:center;background-color:rgba(0,0,0,.5)}.user video[data-v-02a9d378]{position:absolute;top:0;left:0;width:320px;height:240px}.user[data-v-e412343a]{width:320px;height:240px;border:1px solid gray;position:relative;color:#fff;background-color:#000}.title[data-v-e412343a]{position:absolute;bottom:0;left:0;width:100%;height:30px;line-height:30px;text-align:center;background-color:rgba(0,0,0,.5)}.mic[data-v-e412343a]{cursor:pointer;position:absolute;bottom:0;left:0;width:30px;height:30px}.user video[data-v-e412343a]{position:absolute;top:0;left:0;width:320px;height:240px}.user .camlist[data-v-e412343a]{position:absolute;bottom:-35px;left:0;width:320px}.card-tabs .n-tabs-nav--bar-type[data-v-297af40a]{padding-left:4px}\n",document.head.appendChild(d),{setters:[e=>{a=e._,o=e.c,u=e.s},e=>{l=e.g,n=e.i},e=>{r=e.u},e=>{c=e.v},e=>{i=e.W,s=e.a}],execute:function(){const t={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 20 20"},d={id:"volume",x1:"0%",y1:"60%",x2:"0%",y2:"0%"},v=Vue.createElementVNode("stop",{offset:"0%","stop-color":"cyan","stop-opacity":"1"},null,-1),V=["offset"],p=["offset"],m=Vue.createElementVNode("stop",{offset:"100%","stop-color":"cyan","stop-opacity":"0"},null,-1),f=Vue.createElementVNode("path",{d:"M5.5 10a.5.5 0 0 0-1 0a5.5 5.5 0 0 0 5 5.478V17.5a.5.5 0 0 0 1 0v-2.022a5.5 5.5 0 0 0 5-5.478a.5.5 0 0 0-1 0a4.5 4.5 0 1 1-9 0zm7.5 0a3 3 0 0 1-6 0V5a3 3 0 0 1 6 0v5z",fill:"url(#volume)"},null,-1),h=Vue.createElementVNode("path",{d:"M10 13a3 3 0 0 0 3-3V5a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm0-1a2 2 0 0 1-2-2V5a2 2 0 1 1 4 0v5a2 2 0 0 1-2 2zM5 9.5a.5.5 0 0 1 .5.5a4.5 4.5 0 1 0 9 0a.5.5 0 0 1 1 0a5.5 5.5 0 0 1-5 5.478V17.5a.5.5 0 0 1-1 0v-2.022A5.5 5.5 0 0 1 4.5 10a.5.5 0 0 1 .5-.5z",fill:"currentColor"},null,-1),k={key:1,d:"M12 5v4.879l.898.898c.067-.248.102-.508.102-.777V5a3 3 0 0 0-5.998-.119L8 5.879V5a2 2 0 1 1 4 0zM7 7.707L2.146 2.854a.5.5 0 1 1 .708-.708l15 15a.5.5 0 0 1-.708.708l-3.627-3.627a5.475 5.475 0 0 1-3.019 1.25V17.5a.5.5 0 0 1-1 0v-2.022A5.5 5.5 0 0 1 4.5 10a.5.5 0 0 1 1 0a4.5 4.5 0 0 0 7.309 3.516l-1.07-1.07A3 3 0 0 1 7 10V7.706zm4.016 4.016L8 8.707V10a2 2 0 0 0 3.016 1.723zm3.787.959l-.742-.742A4.481 4.481 0 0 0 14.5 10a.5.5 0 0 1 1 0c0 .974-.253 1.888-.697 2.682z",fill:"currentColor"},y={key:2,d:"M9 13c.07 0 .14-.002.21-.007c.11-.387.26-.757.448-1.104A2 2 0 0 1 7 10V5.001a2 2 0 1 1 4 0v5c0 .092-.006.183-.018.272c.312-.26.653-.486 1.018-.672V5a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm-4.5-3A4.5 4.5 0 0 0 9 14.5c0 .819.179 1.596.5 2.294v.706a.5.5 0 0 1-1 0v-2.022A5.5 5.5 0 0 1 3.5 10a.5.5 0 0 1 1 0zm10 9a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9zm0-8a3.5 3.5 0 0 0-2.803 5.596l4.9-4.9A3.484 3.484 0 0 0 14.5 11zm-2.096 6.303a3.5 3.5 0 0 0 4.9-4.9l-4.9 4.9z",fill:"currentColor"},g=Vue.defineComponent({__name:"mic",props:{hasMic:{type:Boolean},muted:{type:Boolean},volume:null},setup:e=>(a,o)=>(Vue.openBlock(),Vue.createElementBlock("svg",t,[Vue.createElementVNode("defs",null,[Vue.createElementVNode("linearGradient",d,[v,Vue.createElementVNode("stop",{offset:e.volume+"%","stop-color":"cyan","stop-opacity":"1"},null,8,V),Vue.createElementVNode("stop",{offset:e.volume+.1+"%","stop-color":"cyan","stop-opacity":"0"},null,8,p),m])]),Vue.createElementVNode("g",null,[e.hasMic&&!e.muted?(Vue.openBlock(),Vue.createElementBlock(Vue.Fragment,{key:0},[f,h],64)):e.hasMic?(Vue.openBlock(),Vue.createElementBlock("path",k)):(Vue.openBlock(),Vue.createElementBlock("path",y))])]))}),x={class:"user"},w=["srcObject"],C={class:"title"},b=a(Vue.defineComponent({__name:"user",props:{value:null,title:null,audioContext:null},setup(e){const t=e,a=Vue.ref(),o=new MediaStream,u=Vue.ref(0);return Vue.watchEffect((()=>{if(t.value){if(t.value.audioTrack&&0==o.getAudioTracks().length){let e=function(){if("closed"==t.audioContext.state)return;l.getByteFrequencyData(n);let a=0;for(let e=0;e<n.length;e++)a+=n[e];u.value=a/n.length,requestAnimationFrame(e)};o.addTrack(t.value.audioTrack);const a=t.audioContext.createMediaStreamSource(o),l=t.audioContext.createAnalyser();a.connect(l);const n=new Uint8Array(l.frequencyBinCount);e()}t.value.videoTrack&&0==o.getVideoTracks().length&&o.addTrack(t.value.videoTrack),(t.value.audioTrack||t.value.videoTrack)&&a.value&&a.value.play()}})),(t,l)=>(Vue.openBlock(),Vue.createElementBlock("div",x,[Vue.createElementVNode("video",{ref_key:"videoEle",ref:a,srcObject:Vue.unref(o),autoplay:""},null,8,w),Vue.createElementVNode("div",C,[Vue.createTextVNode(Vue.toDisplayString(e.title)+" ",1),Vue.createVNode(g,{class:"mic",muted:e.value&&e.value.audioTrack&&!e.value.audioTrack.enabled,"has-mic":e.value&&e.value.audioTrack,volume:u.value},null,8,["muted","has-mic","volume"])])]))}}),[["__scopeId","data-v-02a9d378"]]),N={class:"user"},S={class:"title"},T={key:0,class:"camlist"},B=Vue.defineComponent({__name:"myself",props:{value:null,title:null,signalReady:{type:Boolean},audioContext:null},emits:["update:value","publish","unpublish"],setup(e,{emit:t}){const a=e,u=Vue.ref(),l=Vue.ref([]),n=o(),r=Vue.ref(n.getCurrentCamera),c=Vue.ref(),i=Vue.ref(0),s=new MediaStream;function d(){c.value&&(c.value.enabled=!c.value.enabled)}return navigator.mediaDevices.enumerateDevices().then((e=>{l.value=e.filter((e=>"videoinput"==e.kind)),l.value.find((e=>e.deviceId==r.value))||(r.value=l.value[0].deviceId)})),Vue.onUnmounted((()=>{a.value.mediaStream&&a.value.mediaStream.getTracks().forEach((e=>e.stop()))})),Vue.watchEffect((()=>{n.setCurrentCamera(r.value),navigator.mediaDevices.getUserMedia({audio:!0,video:!r.value||{deviceId:r.value}}).then((e=>{a.value.mediaStream&&a.value.mediaStream.getTracks().forEach((e=>e.stop())),a.value.mediaStream=e,c.value=e.getAudioTracks()[0];const o=e.getVideoTracks()[0];if(c.value){if(0==s.getAudioTracks().length){let e=function(){if("closed"==a.audioContext.state)return;o.getByteFrequencyData(u);let t=0;for(let e=0;e<u.length;e++)t+=u[e];i.value=t/u.length,requestAnimationFrame(e)};s.addTrack(c.value);const t=a.audioContext.createMediaStreamSource(s),o=a.audioContext.createAnalyser();t.connect(o);const u=new Uint8Array(o.frequencyBinCount);e()}else s.removeTrack(s.getAudioTracks()[0]),s.addTrack(c.value);a.value.audioTransceiver&&a.value.audioTransceiver.sender.replaceTrack(c.value)}a.value.videoTransceiver&&o&&a.value.videoTransceiver.sender.replaceTrack(o),t("update:value",a.value)}))})),Vue.watchEffect((()=>{a.value.mediaStream&&u.value&&(u.value.srcObject=a.value.mediaStream,u.value.muted=!0,u.value.play().catch((()=>{})))})),(t,a)=>{const o=Vue.resolveComponent("n-select");return Vue.openBlock(),Vue.createElementBlock("div",N,[Vue.createElementVNode("video",{ref_key:"videoEle",ref:u,autoplay:""},null,512),Vue.createElementVNode("div",S,[Vue.createTextVNode(Vue.toDisplayString(e.title)+" ",1),Vue.createVNode(g,{class:"mic",onClick:d,muted:null!=c.value&&!c.value.enabled,"has-mic":null!=c.value,volume:i.value},null,8,["muted","has-mic","volume"])]),l.value.length>1?(Vue.openBlock(),Vue.createElementBlock("div",T,[Vue.createVNode(o,{value:r.value,"onUpdate:value":a[0]||(a[0]=e=>r.value=e),options:l.value,"value-field":"deviceId"},null,8,["value","options"])])):Vue.createCommentVNode("",!0)])}}}),_=a(B,[["__scopeId","data-v-e412343a"]]),E=Vue.createTextVNode(" 正在等待WebRTC连接 "),D=Vue.createTextVNode(" WebRTC已连接 "),A=Vue.createTextVNode(" 正在发布流 "),I=Vue.createTextVNode(" 当前实例未安装插件，无法创建房间 "),z=Vue.createTextVNode("发送"),M=Vue.createTextVNode("返回"),P=Vue.createTextVNode(" 进入 ");e("default",a(Vue.defineComponent({__name:"index",setup(e){const t=Vue.ref(!0),a=l(),o=Vue.reactive([]),d=Vue.ref(""),v=n(),V=naive.useMessage(),p=Vue.ref("usr"+Math.random().toString(36).substr(2,9)),m=Vue.ref("");let f;const h=r(),k=v.params.id,y=Vue.ref(!1),g=Vue.ref("room"),x=Vue.ref(v.query.pass||"test"),w=Vue.ref(""),C=Vue.ref(!1),N=Vue.ref(),S=Vue.ref(!1),T=Vue.computed((()=>location.protocol+"//"+location.host+"/#/instance/room?pass="+w.value));let B,j="wss://console.monibuca.com:9999";const R=Vue.ref(),U=new i("m7s/webrtc/batch",{requestInit:{headers:{m7sid:k}}}),L=U.webrtc,O=new AudioContext;function q(){navigator.clipboard.writeText(T.value).then((()=>{V.success("链接已复制到剪切板")}))}function $(e){"Enter"===e.key&&Q()}function F(){k?(c(k,x.value).then((e=>{w.value=e})),W([j,"room",x.value,p.value].join("/")+"?m7sid="+k)):(W(`${j}/room/join?${new URLSearchParams({userId:p.value,pass:x.value})}`),U.options.requestInit.headers.pass=x.value)}async function J(){if(R.value&&R.value.mediaStream&&C.value&&!S.value){S.value=!0;const e=R.value;U.addStream(e);const t=await L.createOffer();await L.setLocalDescription(t),B.send(JSON.stringify({type:"publish",offer:t.sdp,streamPath:`room/${x.value}/${p.value}?token=${m.value}`}))}}function W(e){R.value=new s(p.value,"sendonly"),f=new WebSocket(e),f.onmessage=e=>{const{data:a,event:u,userId:l}=JSON.parse(e.data);switch(u){case"joined":if(m.value=a.token,x.value=m.value.split(":")[0],V.success("成功加入房间"),t.value=!1,B=L.createDataChannel("signal"),B.onmessage=async e=>{const t=JSON.parse(e.data);switch(t.type){case"answer":L.setRemoteDescription(new RTCSessionDescription(t));break;case"remove":U.deleteStream(t.streamPath);const e=o.find((e=>e.StreamPath==t.streamPath));e&&(e.StreamPath="");break;case"offer":await L.setRemoteDescription(new RTCSessionDescription(t));const a=await L.createAnswer();await L.setLocalDescription(a),B.send(JSON.stringify(a))}},B.onopen=async()=>{V.success("成功连接信令服务器"),C.value=!0,J(),G()},B.onclose=()=>{V.error("信令服务器连接断开"),C.value=!1},a.userList)for(const t of a.userList){if(H(t.ID))continue;o.push(t);const e=t.StreamPath;e&&(t.Stream=Vue.reactive(new s(e)),U.addStream(t.Stream))}U.connect().catch((e=>{N.value=e,V.error("连接失败"+e)}));break;case"msg":V.info(`${l}：${a}`);break;case"userjoin":V.success(a.ID+"加入房间"),H(a.ID)||o.push(a);break;case"userleave":V.info(l+"离开房间");{const e=K(l);e&&(e.StreamPath&&U.deleteStream(e.StreamPath),o.splice(o.findIndex((e=>e.ID===l)),1))}break;case"publish":const e=a,u=K(l);u&&!H(l)&&(u.StreamPath=e,u.Stream=new s(e),U.addStream(u.Stream),G())}},f.onerror=e=>{V.error("进入房间失败")}}async function G(){if(!C.value)return;const e=[];for(const a of o)a.StreamPath&&e.push(a.StreamPath);const t=await L.createOffer();await L.setLocalDescription(t),B.send(JSON.stringify({type:"subscribe",offer:t.sdp,streamList:e}))}function K(e){return o.find((t=>t.ID===e))}function H(e){return p.value===e}function Q(){f?(f.send(d.value),d.value=""):V.error("未连接到服务器")}return Vue.onUnmounted((()=>{O.close(),U.close(),f?.close()})),u({url:"/api/user/islogin",method:"POST"}).then((e=>{0===e.code&&(p.value=e.data)})),k&&(h.getConfig(k,"Room").then((e=>g.value=e.appname)).catch((()=>y.value=!0)),h.getConfig(k,"").then((e=>{j="wss://"+(/[^:\/]+/.exec(e.console.server)?.[0]||"console.monibuca.com")+":9999"}))),(e,u)=>{const l=Vue.resolveComponent("n-alert"),n=Vue.resolveComponent("n-space"),r=Vue.resolveComponent("n-layout-content"),c=Vue.resolveComponent("n-input"),i=Vue.resolveComponent("n-button"),s=Vue.resolveComponent("n-input-group"),v=Vue.resolveComponent("n-layout-footer"),V=Vue.resolveComponent("n-form-item-row"),m=Vue.resolveComponent("n-form"),f=Vue.resolveComponent("n-card"),h=Vue.resolveComponent("n-modal"),g=Vue.resolveComponent("n-layout");return Vue.openBlock(),Vue.createBlock(g,null,{default:Vue.withCtx((()=>[Vue.createVNode(r,{"content-style":"padding: 24px;height:calc(100vh - 120px)"},{default:Vue.withCtx((()=>[Vue.createVNode(n,null,{default:Vue.withCtx((()=>[N.value?(Vue.openBlock(),Vue.createBlock(l,{key:0,type:"error"},{default:Vue.withCtx((()=>[Vue.createTextVNode(" WebRTC连接失败："+Vue.toDisplayString(N.value),1)])),_:1})):C.value?(Vue.openBlock(),Vue.createBlock(l,{key:2,type:"success"},{default:Vue.withCtx((()=>[D])),_:1})):(Vue.openBlock(),Vue.createBlock(l,{key:1,type:"warning"},{default:Vue.withCtx((()=>[E])),_:1})),S.value?(Vue.openBlock(),Vue.createBlock(l,{key:3,type:"success"},{default:Vue.withCtx((()=>[A])),_:1})):Vue.createCommentVNode("",!0),y.value?(Vue.openBlock(),Vue.createBlock(l,{key:4,title:"当前功能受限",type:"error"},{default:Vue.withCtx((()=>[I])),_:1})):w.value?(Vue.openBlock(),Vue.createBlock(l,{key:5,type:"success",onClick:q},{default:Vue.withCtx((()=>[Vue.createTextVNode("邀请他人入房链接（点击复制到剪切板）："+Vue.toDisplayString(Vue.unref(T)),1)])),_:1})):Vue.createCommentVNode("",!0)])),_:1}),Vue.createVNode(n,null,{default:Vue.withCtx((()=>[R.value?(Vue.openBlock(),Vue.createBlock(_,{key:0,title:p.value,value:R.value,signalReady:C.value,"onUpdate:value":J,"audio-context":Vue.unref(O)},null,8,["title","value","signalReady","audio-context"])):Vue.createCommentVNode("",!0),(Vue.openBlock(!0),Vue.createElementBlock(Vue.Fragment,null,Vue.renderList(o,(e=>(Vue.openBlock(),Vue.createBlock(b,{title:e.ID,key:e.ID,value:e.Stream,"audio-context":Vue.unref(O)},null,8,["title","value","audio-context"])))),128))])),_:1})])),_:1}),Vue.createVNode(v,null,{default:Vue.withCtx((()=>[Vue.createVNode(s,null,{default:Vue.withCtx((()=>[Vue.createVNode(c,{value:d.value,"onUpdate:value":u[0]||(u[0]=e=>d.value=e),clearable:"",placeholder:"发送聊天信息",onKeyup:$},null,8,["value"]),Vue.createVNode(i,{type:"primary",onClick:Q},{default:Vue.withCtx((()=>[z])),_:1})])),_:1})])),_:1}),Vue.createVNode(h,{show:t.value,"onUpdate:show":u[4]||(u[4]=e=>t.value=e),"close-on-esc":!1,"mask-closable":!1},{default:Vue.withCtx((()=>[Vue.createVNode(f,{style:{width:"600px"},title:Vue.unref(k)?"进入房间":"加入房间",bordered:!1,size:"huge",role:"dialog","aria-modal":"true"},{"header-extra":Vue.withCtx((()=>[Vue.createVNode(i,{type:"primary",onClick:u[1]||(u[1]=e=>Vue.unref(a).back())},{default:Vue.withCtx((()=>[M])),_:1})])),footer:Vue.withCtx((()=>[Vue.createVNode(i,{type:"primary",block:"",secondary:"",strong:"",onClick:F},{default:Vue.withCtx((()=>[P])),_:1})])),default:Vue.withCtx((()=>[Vue.createVNode(m,null,{default:Vue.withCtx((()=>[Vue.createVNode(V,{label:Vue.unref(k)?"房间名称":"入房口令"},{default:Vue.withCtx((()=>[Vue.createVNode(c,{value:x.value,"onUpdate:value":u[2]||(u[2]=e=>x.value=e)},null,8,["value"])])),_:1},8,["label"]),Vue.createVNode(V,{label:"用户名称"},{default:Vue.withCtx((()=>[Vue.createVNode(c,{value:p.value,"onUpdate:value":u[3]||(u[3]=e=>p.value=e)},null,8,["value"])])),_:1})])),_:1})])),_:1},8,["title"])])),_:1},8,["show"])])),_:1})}}}),[["__scopeId","data-v-297af40a"]]))}}}));
